#!/data/data/com.termux/files/usr/bin/bash
# === BEGIN METADATA ===
# name: cmdtree
# description: å‘½ä»¤è¡Œç•Œé¢ - è‡ªç”¨å­—å…¸æ ‘çš„ä¸»å…¥å£ç¨‹åº
# usage: cmdtree [scan|search|explain|stats] [args...]
# version: 1.1.0
# author: TurinFohlen
# dependencies: python3, query-engine
# tags: CLI, ç”¨æˆ·ç•Œé¢
# === END METADATA ===

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# è„šæœ¬æ‰€åœ¨ç›®å½•
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# é»˜è®¤æ‰«æç›®å½•
DEFAULT_SCAN_DIR="$HOME/bin"

show_banner() {
    echo -e "${BLUE}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘      ğŸŒ³ è‡ªç”¨å­—å…¸æ ‘ v1.1.0                 â•‘"
    echo "â•‘      æ™ºèƒ½å‘½ä»¤ç´¢å¼•ä¸æŸ¥è¯¢ç³»ç»Ÿ                â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

show_help() {
    cat << EOF
${GREEN}ç”¨æ³•ï¼š${NC}
  cmdtree scan [directory]     æ‰«æç›®å½•å¹¶å»ºç«‹ç´¢å¼•ï¼ˆé»˜è®¤: ~/binï¼‰
  cmdtree search <query>       æœç´¢å‘½ä»¤ï¼ˆæ”¯æŒè‡ªç„¶è¯­è¨€ï¼‰
  cmdtree explain [-p PROVIDER] <command>  ä½¿ç”¨AIè§£é‡Šå‘½ä»¤
  cmdtree stats                æ˜¾ç¤ºç´¢å¼•ç»Ÿè®¡ä¿¡æ¯
  cmdtree help                 æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯

${YELLOW}ç¤ºä¾‹ï¼š${NC}
  cmdtree scan ~/scripts              # æ‰«æè‡ªå®šä¹‰è„šæœ¬ç›®å½•
  cmdtree search "æ‰¹é‡é‡å‘½å"          # è‡ªç„¶è¯­è¨€æœç´¢
  cmdtree search file                 # å…³é”®è¯æœç´¢
  cmdtree explain -p gemini ls        # ç”¨Geminiè§£é‡Šls
  cmdtree explain cmdtree             # ç”¨é»˜è®¤æä¾›å•†è§£é‡Šè‡ªèº«

${BLUE}æç¤ºï¼š${NC}
  é¦–æ¬¡ä½¿ç”¨è¯·å…ˆè¿è¡Œ 'cmdtree scan' å»ºç«‹ç´¢å¼•
  è®¾ç½®å¯¹åº” API KEY ç¯å¢ƒå˜é‡ä»¥å¯ç”¨ AI åŠŸèƒ½
EOF
}

cmd_scan() {
    local dir="${1:-$DEFAULT_SCAN_DIR}"
    echo -e "${GREEN}ğŸ“ æ‰«æç›®å½•: $dir${NC}"
    
    (
        cd "$SCRIPT_DIR"
        python3 << PYEOF
import sys
sys.path.insert(0, ".")
from file_scanner import FileScanner
from storage_tree import StorageTree

scanner = FileScanner()
storage = StorageTree()

commands = scanner.scan_directory("$dir")
for cmd in commands:
    storage.insert_command(cmd)

storage.save_to_disk()

stats = scanner.get_statistics()
print(f"\nğŸ“Š æ‰«æç»Ÿè®¡ï¼š")
print(f"  æ€»æ–‡ä»¶æ•°: {stats['total_files']}")
print(f"  æœ‰æ•ˆå‘½ä»¤: {stats['valid_commands']}")
print(f"  è¦†ç›–ç‡: {stats['coverage_rate']}")
PYEOF
    )
}

cmd_search() {
    local query="$*"
    if [ -z "$query" ]; then
        echo -e "${RED}âŒ è¯·æä¾›æœç´¢å…³é”®è¯${NC}"
        return 1
    fi
    echo -e "${BLUE}ğŸ” æœç´¢: $query${NC}\n"
    
    (
        cd "$SCRIPT_DIR"
        python3 << PYEOF
import sys
sys.path.insert(0, ".")
from query_engine import QueryEngine

engine = QueryEngine()
results = engine.query("$query")

if not results:
    print("ğŸ˜• æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„å‘½ä»¤")
    print("\nğŸ’¡ æç¤ºï¼š")
    print("  1. å°è¯•ä½¿ç”¨å…¶ä»–å…³é”®è¯")
    print("  2. è¿è¡Œ 'cmdtree scan' æ›´æ–°ç´¢å¼•")
else:
    print(f"æ‰¾åˆ° {len(results)} ä¸ªåŒ¹é…çš„å‘½ä»¤ï¼š\n")
    for i, cmd in enumerate(results, 1):
        name = cmd['name']
        desc = cmd['description']
        match_type = cmd['match_type']
        filepath = cmd.get('filepath', '')
        
        type_emoji = {
            'exact_match': 'ğŸ¯',
            'tag_match': 'ğŸ·ï¸ ',
            'keyword_match': 'ğŸ”‘',
            'ai_recommendation': 'ğŸ¤–'
        }
        emoji = type_emoji.get(match_type, 'ğŸ“')
        
        print(f"{emoji} [{i}] {name}")
        print(f"    æè¿°: {desc}")
        print(f"    è·¯å¾„: {filepath}")
        
        if 'usage' in cmd:
            print(f"    ç”¨æ³•: {cmd['usage']}")
        
        if 'ai_reason' in cmd:
            print(f"    ğŸ’­ AIæ¨èç†ç”±: {cmd['ai_reason']}")
        
        print()
PYEOF
    )
}

cmd_explain() {
    local provider=""
    local command=""
    
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -p|--provider)
                provider="$2"
                shift 2
                ;;
            -*)
                echo "æœªçŸ¥é€‰é¡¹: $1"
                return 1
                ;;
            *)
                command="$1"
                shift
                ;;
        esac
    done

    if [ -z "$command" ]; then
        echo -e "${RED}âŒ è¯·æä¾›è¦è§£é‡Šçš„å‘½ä»¤å${NC}"
        return 1
    fi

    echo -e "${BLUE}ğŸ¤– æ­£åœ¨ä½¿ç”¨AIè§£é‡Šå‘½ä»¤: $command${NC}"
    if [ -n "$provider" ]; then
        echo -e "${YELLOW}ğŸ“Œ ä½¿ç”¨æä¾›å•†: $provider${NC}"
        export AI_PROVIDER="$provider"
    fi

    (
        cd "$SCRIPT_DIR"
        python3 << PYEOF
import sys
sys.path.insert(0, ".")
from query_engine import QueryEngine

engine = QueryEngine()
explanation = engine.explain_command("$command")
if explanation:
    print(explanation)
else:
    print("ğŸ˜• æ— æ³•è§£é‡Šæ­¤å‘½ä»¤")
    print("å¯èƒ½åŸå› ï¼š")
    print("  1. å‘½ä»¤ä¸å­˜åœ¨äºç´¢å¼•ä¸­")
    print("  2. AIåŠŸèƒ½æœªå¯ç”¨ï¼ˆéœ€è®¾ç½®å¯¹åº” API Keyï¼‰")
PYEOF
    )
}

cmd_stats() {
    (
        cd "$SCRIPT_DIR"
        python3 << PYEOF
import sys
sys.path.insert(0, ".")
from storage_tree import StorageTree

storage = StorageTree()
storage.load_from_disk()
stats = storage.get_statistics()
print(f"ğŸ“Š ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯")
print(f"  æ€»å‘½ä»¤æ•°: {stats['total_commands']}")
print(f"  æ€»æ ‡ç­¾æ•°: {stats['total_tags']}")
print(f"  ç´¢å¼•æ–‡ä»¶: {stats['storage_file']}")
PYEOF
    )
}

# ä¸»é€»è¾‘
case "$1" in
    scan)
        show_banner
        cmd_scan "${@:2}"
        ;;
    search)
        cmd_search "${@:2}"
        ;;
    explain)
        cmd_explain "${@:2}"
        ;;
    stats)
        cmd_stats
        ;;
    help|--help|-h|"")
        show_banner
        show_help
        ;;
    *)
        echo -e "${RED}âŒ æœªçŸ¥å‘½ä»¤: $1${NC}"
        echo "è¿è¡Œ 'cmdtree help' æŸ¥çœ‹å¸®åŠ©"
        exit 1
        ;;
esac
